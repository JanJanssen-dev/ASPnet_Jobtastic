@model List<JobPostingModel>

@{
    ViewData["Title"] = "Deine Inserate";
}
<section class="p-4 bg-light rounded shadow-sm">
    <div class="mt-6 p-5 bg-primary text-white rounded text-center">
        <h2>Deine Inserate</h2>
    </div>
    <div class="text-end">
        <a class="mt-3 btn btn-outline-primary" asp-controller="JobPosting" asp-action="CreateJob">neuen Job anlegen</a>
    </div>
    <section class="mt-3 p-4 bg-light rounded shadow-sm">
        <table class="table">
            <thead>
                <tr>
                    <th>Logo</th>
                    <th>Job Titel</th>
                    <th>Company</th>
                    <th>ASP</th>
                    <th>Start am</th>
                    <th>Erstellt am</th>
                    <th>Letzte Änderung</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @if (item.CompanyImage != null && item.CompanyImage.Length > 0)
                            {
                                var base64 = Convert.ToBase64String(item.CompanyImage);
                                <img src="data:image/png;base64,@base64" alt="Logo" style="max-width: 80px; max-height: 40px;" />
                            }
                        </td>
                        <td class="align-middle">@item.JobTitle</td>
                        <td class="align-middle">@item.CompanyName</td>
                        <td class="align-middle">@item.ContactName</td>
                        <td class="align-middle">@item.StartDate.ToShortDateString()</td>
                        <td class="align-middle">
                            @if (item.CreationDate.HasValue)
                            {
                                @item.CreationDate.Value.ToShortDateString()
                            }
                        </td>
                        <td class="align-middle">
                            @if (item.ChangeDate.HasValue)
                            {
                                <small>
                                    @item.ChangeDate.Value.ToShortDateString()
                                    <br />von @item.ChangeUserName
                                </small>
                            }
                        </td>
                        <td class="align-middle">
                            <div class="btn-group" role="group">
                                <!-- Bearbeiten-Button für alle mit Bearbeitungsrecht -->
                                @if (item.IsOwner || item.IsAdmin || item.CanEdit)
                                {
                                    <a asp-action="EditJob" asp-route-id="@item.Id" class="btn btn-primary btn-sm">Bearbeiten</a>
                                }

                                <!-- Freigeben-Button nur für Eigentümer oder Admins -->
                                @if (item.IsOwner || item.IsAdmin)
                                {
                                    <a asp-action="ManageSharing" asp-route-id="@item.Id" class="btn btn-info btn-sm">Freigeben</a>
                                }

                                <!-- Löschen-Button für Eigentümer, Admins oder Benutzer mit Löschberechtigung -->
                                @if (item.IsOwner || item.IsAdmin || item.CanDelete)
                                {
                                    <form asp-action="DeleteJob" asp-route-id="@item.Id" method="post" id="deleteForm-@item.Id">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete(@item.Id, '@item.JobTitle')">Löschen</button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </section>
    <div class="text-end">
        <a class="mt-3 btn btn-outline-primary" asp-controller="JobPosting" asp-action="CreateJob">neuen Job anlegen</a>
    </div>
</section>

@section Scripts {
    <script>
        function confirmDelete(id, jobTitle) {
            Swal.fire({
                title: "Bist du sicher?",
                text: `Möchtest du den Job "${jobTitle}" wirklich löschen?`,
                icon: "info",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Ja, löschen!",
                cancelButtonText: "Abbrechen"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Formular absenden, wenn Benutzer bestätigt
                    document.getElementById(`deleteForm-${id}`).submit();

                    // Erfolgsmeldung (wird angezeigt, wenn das Formular gesendet wurde)
                    Swal.fire({
                        title: "Gelöscht!",
                        text: "Dein Job wurde erfolgreich gelöscht.",
                        icon: "success",
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }
    </script>
}